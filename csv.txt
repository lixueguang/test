ä¸‹é¢ç»™ä½ ä¸€ä»½ å®Œæ•´å¯éƒ¨ç½²çš„æ–¹æ¡ˆï¼ˆä¸­æ–‡ï¼‰ â€”â€” åŒ…å«ï¼š

æ¨¡å‹é©±åŠ¨æŒ‰é’®çš„ Ribbon JSï¼ˆWeb Resourceï¼‰ï¼›

template è¡¨ï¼ˆnew_exporttemplateï¼‰å»ºè®®å­—æ®µï¼›

ä¸€æ•´å¥— C# æ’ä»¶ä»£ç ï¼ˆå¯ç›´æ¥æ”¾åˆ° Visual Studio Class Libraryï¼Œå¼•ç”¨ Microsoft.CrmSdk.CoreAssembliesï¼‰ï¼Œæ’ä»¶æ³¨å†Œåœ¨ new_exporttemplate çš„ Create/Updateï¼ˆstatus->Readyï¼‰ä¸Šï¼ŒAsynchronous æ‰§è¡Œï¼›

æ³¨å†Œ/éƒ¨ç½²æ­¥éª¤ä¸æ³¨æ„äº‹é¡¹ã€‚

æˆ‘æŠŠé‡ç‚¹æ”¾åœ¨ã€Œé€šç”¨æ€§ã€ã€Œé€’å½’ lookupã€ã€Œ1:N å­è¡¨ã€ã€Œé¿å…å¾ªç¯ã€ã€ŒCSV å¯è¯»æ€§ã€ä»¥åŠã€Œç”Ÿäº§æ³¨æ„ç‚¹ã€ã€‚ä»£ç é‡Œéƒ½å†™æœ‰ä¸­æ–‡æ³¨é‡Šï¼Œæ‹¿å»æ”¹å­—æ®µåå°±èƒ½ç›´æ¥ç¼–è¯‘æ³¨å†Œã€‚

ä¸€ã€æ•´ä½“æµç¨‹å›é¡¾ï¼ˆä¸€å¥è¯ï¼‰

ç”¨æˆ·åœ¨æ¨¡å‹é©±åŠ¨è¡¨å•ç‚¹ Export to CSV â†’ JS å†™å…¥ new_exporttemplateï¼ˆtarget entity + id + depth + includeLookupsï¼‰â†’ å¼‚æ­¥ C# æ’ä»¶ç›‘å¬ template çš„ Create / status = Ready â†’ è¯»å–ç›®æ ‡è®°å½•ä¸ metadataï¼Œé€’å½’å¯¼å‡ºä¸»è¡¨ / å­è¡¨ / lookup æŒ‡å‘å®ä½“ä¸ºè‹¥å¹² sectionï¼Œç”Ÿæˆ CSV å†™å…¥ Annotationï¼ˆNoteï¼‰ï¼Œå¹¶åœ¨ template ä¸Šè®°å½•ç»“æœã€‚

äºŒã€templateï¼ˆä»»åŠ¡è¡¨ï¼‰å»ºè®®å­—æ®µï¼ˆéœ€è¦ä½ åœ¨ Dataverse ä¸­åˆ›å»ºï¼‰

è¡¨ logical nameï¼šnew_exporttemplateï¼ˆå¯æŒ‰éœ€æ”¹åï¼Œä½†ä»£ç è¦å¯¹åº”ï¼‰

å­—æ®µï¼ˆschema nameï¼‰ï¼š

new_exporttemplateidï¼ˆä¸»é”® GUIDï¼Œè‡ªåŠ¨ï¼‰

new_targetentitylogicalnameï¼ˆå•è¡Œæ–‡æœ¬ï¼Œä¿å­˜ç›®æ ‡å®ä½“ logical nameï¼‰

new_targetidï¼ˆGUID æˆ– Lookupï¼Œä¿å­˜ç›®æ ‡è®°å½• idï¼‰

new_statusï¼ˆOptionSet / TwoOptionsï¼ŒReady/Processing/Done/Failedï¼‰

new_depthï¼ˆWhole Numberï¼Œé»˜è®¤ 1ï¼Œé€’å½’æ·±åº¦ï¼‰

new_include_lookupsï¼ˆTwoOptions/Booleanï¼Œæ˜¯å¦å¯¼å‡º lookup å¯¹è±¡ä¸ºç‹¬ç«‹ sectionï¼‰

new_result_noteï¼ˆMultiple Lines Textï¼Œå†™å¯¼å‡ºç»“æœ/é”™è¯¯ä¿¡æ¯ï¼‰

ä¸‰ã€æ¨¡å‹é©±åŠ¨æŒ‰é’®ï¼ˆRibbonï¼‰JSï¼ˆWeb Resourceï¼‰

æŠŠä¸‹é¢ä»£ç ä¿å­˜ä¸º createExportRequest.jsï¼Œä¸Šä¼ ä¸º Web Resourceï¼ŒæŒ‰é’®å‘½ä»¤è°ƒç”¨ createExportRequest(executionContext)ï¼ˆç¤ºä¾‹ä½¿ç”¨ Xrm.WebApi.createï¼‰ï¼š
// createExportRequest.js
// åœ¨æ¨¡å‹é©±åŠ¨ Form ä¸Šè°ƒç”¨ï¼šcreateExportRequest(executionContext)
// ä¾èµ–ï¼šXrm å…¨å±€å¯¹è±¡

async function createExportRequest(executionContext) {
    try {
        var formContext = executionContext.getFormContext();
        var id = formContext.data.entity.getId(); // å¸¦ {} çš„ GUID
        if (!id) {
            Xrm.Navigation.openAlertDialog({ text: "æœªè·å–åˆ°å½“å‰è®°å½• ID" });
            return;
        }
        // å»æ‰å¤§æ‹¬å·
        id = id.replace("{", "").replace("}", "");
        var entityName = formContext.data.entity.getEntityName();

        // è¯»å– depth / includeLookups å¯ä»è¡¨å•å­—æ®µæˆ–å›ºå®šå€¼
        var depth = 2;
        var includeLookups = true;

        var body = {
            "new_targetentitylogicalname": entityName,
            "new_targetid": id,
            "new_status": 100000000, // ä¾‹å¦‚è‡ªå®šä¹‰çŠ¶æ€ Ready
            "new_depth": depth,
            "new_include_lookups": includeLookups
        };

        await Xrm.WebApi.createRecord("new_exporttemplate", body);
        Xrm.Navigation.openAlertDialog({ text: "å¯¼å‡ºè¯·æ±‚å·²åˆ›å»ºï¼Œç³»ç»Ÿå°†å¼‚æ­¥ç”Ÿæˆ CSVã€‚" });
    } catch (err) {
        Xrm.Navigation.openAlertDialog({ text: "åˆ›å»ºå¯¼å‡ºè¯·æ±‚å¤±è´¥ï¼š" + err.message });
    }
}
æ³¨æ„ï¼šå¦‚æœ new_targetid æ˜¯ Lookup å­—æ®µè¯·æ”¹ä¸º new_targetid@odata.bind ç»‘å®šè¯­æ³•æˆ–ç›´æ¥å†™ GUID åˆ°æ–‡æœ¬å­—æ®µï¼›ä¸Šé¢ç¤ºä¾‹æŠŠ GUID ä½œä¸ºæ™®é€š guid å­—æ®µå†™å…¥ï¼ˆéœ€è¦ä½ åœ¨ template è¡¨ä¸­æŠŠ new_targetid å®šä¹‰ä¸ºç±»å‹ Guid æˆ–å•è¡Œæ–‡æœ¬ï¼‰ã€‚


å››ã€å®Œæ•´ C# æ’ä»¶ä»£ç ï¼ˆRecursiveCsvExportPlugin.csï¼‰

å°†ä¸‹é¢ä»£ç æ”¾å…¥ Visual Studio Class Libraryï¼ˆ.NET Framework ä¸ Dataverse SDK ç‰ˆæœ¬ç›¸é…ï¼‰ï¼Œå¼•ç”¨ NuGet åŒ… Microsoft.CrmSdk.CoreAssembliesã€‚ä»£ç å·²å°½é‡å†™æ˜éœ€æ›¿æ¢çš„å¸¸é‡åŠæ³¨æ„ç‚¹ã€‚

using System;
using System.Text;
using System.Linq;
using System.Collections.Generic;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Query;
using Microsoft.Xrm.Sdk.Messages;
using Microsoft.Xrm.Sdk.Metadata;

namespace DataversePlugins
{
    /// <summary>
    /// é€šç”¨é€’å½’ CSV å¯¼å‡ºæ’ä»¶
    /// æ³¨å†Œç‚¹ï¼šnew_exporttemplate(Create æˆ– Update status->Ready)ï¼Œå¼‚æ­¥ PostOperation
    /// ä¾èµ– NuGet: Microsoft.CrmSdk.CoreAssemblies
    /// </summary>
    public class RecursiveCsvExportPlugin : IPlugin
    {
        // ----------------- è¯·æ ¹æ®ä½ å®é™… template è¡¨å­—æ®µæ›¿æ¢ä¸‹é¢å¸¸é‡ -----------------
        private const string TemplateEntityLogicalName = "new_exporttemplate";
        private const string Template_TargetEntityField = "new_targetentitylogicalname"; // string
        private const string Template_TargetIdField = "new_targetid"; // guid æˆ– lookup
        private const string Template_DepthField = "new_depth"; // int
        private const string Template_IncludeLookupsField = "new_include_lookups"; // bool
        private const string Template_ResultField = "new_result_note"; // multi-line text
        // ------------------------------------------------------------------------------

        // æ³¨é‡Šé™„ä»¶å¤§å°é˜ˆå€¼ï¼ˆç¤ºä¾‹ï¼‰ï¼Œè‹¥è¶…å‡ºå»ºè®®ä¸Šä¼ åˆ° Blob/SharePoint
        private const int AnnotationMaxBytes = 5 * 1024 * 1024; // 5 MB

        public void Execute(IServiceProvider serviceProvider)
        {
            var context = (IPluginExecutionContext)serviceProvider.GetService(typeof(IPluginExecutionContext));
            var factory = (IOrganizationServiceFactory)serviceProvider.GetService(typeof(IOrganizationServiceFactory));
            var service = factory.CreateOrganizationService(context.UserId);
            var tracing = (ITracingService)serviceProvider.GetService(typeof(ITracingService));

            try
            {
                if (!context.InputParameters.Contains("Target") || !(context.InputParameters["Target"] is Entity))
                    return;

                var template = (Entity)context.InputParameters["Target"];

                // è¯»å– template å­—æ®µï¼ˆé˜²æ­¢åœ¨ Update ä¸­éƒ¨åˆ†å­—æ®µä¸å­˜åœ¨ï¼‰
                string targetEntityLogicalName = GetString(template, Template_TargetEntityField);
                Guid targetId = GetGuid(template, Template_TargetIdField);
                int depth = GetInt(template, Template_DepthField, 1);
                bool includeLookups = GetBool(template, Template_IncludeLookupsField, true);

                // å¦‚æœ targetId ä¸ºç©ºï¼Œå°è¯•åœ¨ template çš„ lookup å­—æ®µä¸­æ‰¾åˆ°
                if (targetId == Guid.Empty)
                {
                    foreach (var kv in template.Attributes)
                    {
                        if (kv.Value is EntityReference er && (kv.Key.IndexOf("target", StringComparison.OrdinalIgnoreCase) >= 0 || kv.Key.IndexOf("record", StringComparison.OrdinalIgnoreCase) >= 0))
                        {
                            targetId = er.Id;
                            if (string.IsNullOrEmpty(targetEntityLogicalName)) targetEntityLogicalName = er.LogicalName;
                            break;
                        }
                    }
                }

                if (string.IsNullOrEmpty(targetEntityLogicalName) || targetId == Guid.Empty)
                {
                    UpdateTemplateResult(service, template, "æ¨¡æ¿ä¿¡æ¯ä¸å®Œæ•´ï¼šç¼ºå°‘ç›®æ ‡å®ä½“æˆ–ç›®æ ‡ IDã€‚");
                    return;
                }

                // 1. è·å–ä¸»å®ä½“ metadata ä¸è®°å½•
                var mainMeta = RetrieveEntityMetadata(service, targetEntityLogicalName);
                if (mainMeta == null)
                {
                    UpdateTemplateResult(service, template, $"æ— æ³•è·å–å®ä½“å…ƒæ•°æ®ï¼š{targetEntityLogicalName}");
                    return;
                }
                var mainRecord = service.Retrieve(targetEntityLogicalName, targetId, new ColumnSet(true));

                // 2. é€’å½’å¯¼å‡º
                var sb = new StringBuilder();
                var visited = new HashSet<string>(StringComparer.OrdinalIgnoreCase); // é˜²æ­¢å¾ªç¯
                var exportedSections = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

                ExportEntityRecursive(service, mainMeta, mainRecord, sb, visited, exportedSections, depth, includeLookups, tracing);

                // 3. å†™å…¥ Annotationï¼ˆæˆ–ä¸Šä¼ åˆ°å¤–éƒ¨ï¼‰
                var csvBytes = Encoding.UTF8.GetBytes(sb.ToString());
                if (csvBytes.Length > AnnotationMaxBytes)
                {
                    // è‹¥æ–‡ä»¶å¤ªå¤§ï¼Œå»ºè®®ä¸Šä¼ åˆ° Blob/SharePoint å¹¶å°†é“¾æ¥å†™åˆ° template.new_result_note
                    UpdateTemplateResult(service, template, $"å¯¼å‡ºæˆåŠŸä½†æ–‡ä»¶è¿‡å¤§ï¼ˆ{csvBytes.Length} bytesï¼‰ï¼Œè¶…å‡ºæ³¨é‡Šé™åˆ¶ï¼Œè¯·ä½¿ç”¨å¤–éƒ¨å­˜å‚¨ã€‚");
                    return;
                }

                var note = new Entity("annotation");
                note["subject"] = $"Export CSV: {targetEntityLogicalName} - {targetId}";
                note["filename"] = $"{targetEntityLogicalName}_{targetId}.csv";
                note["mimetype"] = "text/csv";
                note["documentbody"] = Convert.ToBase64String(csvBytes);
                note["filesize"] = csvBytes.Length;
                note["notetext"] = "ç”± RecursiveCsvExportPlugin è‡ªåŠ¨ç”Ÿæˆ";
                note["objectid"] = new EntityReference(targetEntityLogicalName, targetId);
                service.Create(note);

                UpdateTemplateResult(service, template, $"å¯¼å‡ºæˆåŠŸï¼Œé™„ä»¶å¤§å°ï¼š{csvBytes.Length} bytesã€‚");
            }
            catch (Exception ex)
            {
                tracing.Trace("RecursiveCsvExportPlugin error: " + ex.ToString());
                try
                {
                    if (context.InputParameters.Contains("Target") && context.InputParameters["Target"] is Entity template)
                        UpdateTemplateResult(service, template, "å¯¼å‡ºå¤±è´¥ï¼š" + ex.Message);
                }
                catch { }
                throw;
            }
        }

        #region é€’å½’å¯¼å‡ºæ ¸å¿ƒ

        private void ExportEntityRecursive(IOrganizationService service,
                                           EntityMetadata meta,
                                           Entity instance,
                                           StringBuilder sb,
                                           HashSet<string> visited,
                                           HashSet<string> exportedSections,
                                           int depthLeft,
                                           bool includeLookups,
                                           ITracingService tracing)
        {
            if (meta == null || instance == null) return;

            string key = $"{meta.LogicalName}:{instance.Id}";
            if (visited.Contains(key))
            {
                tracing.Trace($"è·³è¿‡å·²è®¿é—®è®°å½• {key}");
                return;
            }
            visited.Add(key);

            // æŠŠå½“å‰å®ä½“ä½œä¸ºä¸€ä¸ª section å¯¼å‡ºï¼ˆheader + ä¸€è¡Œæ•°æ®ï¼‰
            string sectionId = $"Entity:{meta.LogicalName}:{instance.Id}";
            if (!exportedSections.Contains(sectionId))
            {
                exportedSections.Add(sectionId);
                AppendEntitySection(service, meta, instance, sb, tracing);
            }

            // å¯¼å‡º 1:N å­è¡¨ï¼ˆSub Tableï¼‰
            if (meta.OneToManyRelationships != null)
            {
                foreach (var rel in meta.OneToManyRelationships)
                {
                    try
                    {
                        var childLogicalName = rel.ReferencingEntity;
                        var childRefAttr = rel.ReferencingAttribute;
                        if (string.IsNullOrEmpty(childLogicalName)) continue;

                        var qe = new QueryExpression(childLogicalName) { ColumnSet = new ColumnSet(true) };
                        if (!string.IsNullOrEmpty(childRefAttr))
                        {
                            qe.Criteria.AddCondition(childRefAttr, ConditionOperator.Equal, instance.Id);
                        }
                        else
                        {
                            // fallback: åœ¨ child metadata æ‰¾åˆ°æŒ‡å‘å½“å‰ entity çš„ lookup
                            var childMeta = RetrieveEntityMetadata(service, childLogicalName);
                            string found = null;
                            if (childMeta != null)
                            {
                                foreach (var a in childMeta.Attributes.OfType<LookupAttributeMetadata>())
                                {
                                    if (a.Targets != null && a.Targets.Contains(meta.LogicalName))
                                    {
                                        found = a.SchemaName;
                                        break;
                                    }
                                }
                            }
                            if (!string.IsNullOrEmpty(found))
                                qe.Criteria.AddCondition(found, ConditionOperator.Equal, instance.Id);
                            else
                                continue;
                        }

                        var children = RetrieveAll(service, qe);

                        sb.AppendLine($"\"Sub Table: {childLogicalName} (relationship: {rel.SchemaName})\"");
                        if (children.Entities.Count == 0)
                        {
                            sb.AppendLine("\"No records\"");
                            sb.AppendLine();
                        }
                        else
                        {
                            var childMetaFull = RetrieveEntityMetadata(service, childLogicalName);
                            var childAttrs = childMetaFull.Attributes.Where(a => a.AttributeType != AttributeTypeCode.Virtual).ToList();
                            var childCols = childAttrs.Select(a => a.LogicalName).ToList();
                            sb.AppendLine(string.Join(",", childCols.Select(c => CsvEscape(c))));

                            foreach (var ch in children.Entities)
                            {
                                var row = new List<string>();
                                foreach (var col in childCols)
                                {
                                    if (ch.Attributes.Contains(col))
                                    {
                                        var attrMeta = childAttrs.FirstOrDefault(a => a.LogicalName == col);
                                        var raw = ch[col];
                                        var s = ConvertAttributeValueToString(service, raw, attrMeta, 1);
                                        row.Add(CsvEscape(s));
                                    }
                                    else row.Add(CsvEscape(""));
                                }
                                sb.AppendLine(string.Join(",", row));
                            }
                            sb.AppendLine();
                        }

                        // å¯¹å­è¡¨ä¸­æ¯æ¡è®°å½•çš„ lookup å­—æ®µé€’å½’å¯¼å‡ºï¼ˆå¦‚æœ depthLeft>0 ä¸” includeLookups=trueï¼‰
                        if (depthLeft > 0 && includeLookups)
                        {
                            foreach (var ch in children.Entities)
                            {
                                foreach (var attr in ch.Attributes)
                                {
                                    if (attr.Value is EntityReference er)
                                    {
                                        var refMeta = RetrieveEntityMetadata(service, er.LogicalName);
                                        if (refMeta == null) continue;
                                        var refEntity = service.Retrieve(er.LogicalName, er.Id, new ColumnSet(true));
                                        ExportEntityRecursive(service, refMeta, refEntity, sb, visited, exportedSections, depthLeft - 1, includeLookups, tracing);
                                    }
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        tracing.Trace($"å¯¼å‡ºå­è¡¨ {rel.SchemaName} å‡ºé”™: {ex.Message}");
                    }
                }
            }

            // å¯¼å‡ºå½“å‰å®ä½“çš„ lookup æŒ‡å‘ï¼ˆRelated Tableï¼‰
            if (depthLeft > 0 && includeLookups)
            {
                foreach (var attr in instance.Attributes)
                {
                    if (attr.Value is EntityReference er)
                    {
                        try
                        {
                            string refSection = $"Entity:{er.LogicalName}:{er.Id}";
                            if (exportedSections.Contains(refSection)) continue;

                            var refMeta = RetrieveEntityMetadata(service, er.LogicalName);
                            if (refMeta == null) continue;
                            var refEntity = service.Retrieve(er.LogicalName, er.Id, new ColumnSet(true));
                            ExportEntityRecursive(service, refMeta, refEntity, sb, visited, exportedSections, depthLeft - 1, includeLookups, tracing);
                        }
                        catch (Exception ex)
                        {
                            tracing.Trace($"å¯¼å‡ºå¼•ç”¨å®ä½“ {er.LogicalName}:{er.Id} å¤±è´¥: {ex.Message}");
                        }
                    }
                }
            }
        }

        // å°†å®ä½“å†™å…¥ä¸ºä¸€ä¸ª sectionï¼ˆæ ‡é¢˜ + header + ä¸€è¡Œæ•°æ®ï¼‰
        private void AppendEntitySection(IOrganizationService service, EntityMetadata meta, Entity entity, StringBuilder sb, ITracingService tracing)
        {
            sb.AppendLine($"\"Entity: {meta.LogicalName} (id: {entity.Id})\"");
            var attrs = meta.Attributes.Where(a => a.AttributeType != AttributeTypeCode.Virtual).ToList();
            var headers = attrs.Select(a => a.LogicalName).ToArray();
            sb.AppendLine(string.Join(",", headers.Select(h => CsvEscape(h))));
            var vals = new List<string>();
            foreach (var a in attrs)
            {
                string s = "";
                if (entity.Attributes.Contains(a.LogicalName))
                {
                    var raw = entity[a.LogicalName];
                    s = ConvertAttributeValueToString(service, raw, a, 1);
                }
                vals.Add(CsvEscape(s));
            }
            sb.AppendLine(string.Join(",", vals));
            sb.AppendLine();
        }

        #endregion

        #region è¾…åŠ©ï¼šmetadata, retrieve, convert, csv escape

        private EntityMetadata RetrieveEntityMetadata(IOrganizationService service, string logicalName)
        {
            try
            {
                var req = new RetrieveEntityRequest
                {
                    LogicalName = logicalName,
                    EntityFilters = EntityFilters.Attributes | EntityFilters.Relationships,
                    RetrieveAsIfPublished = true
                };
                var resp = (RetrieveEntityResponse)service.Execute(req);
                return resp.EntityMetadata;
            }
            catch
            {
                return null;
            }
        }

        private EntityCollection RetrieveAll(IOrganizationService service, QueryExpression qe)
        {
            var result = new EntityCollection();
            int page = 1;
            int fetch = 5000;
            qe.PageInfo = new PagingInfo { Count = fetch, PageNumber = page, PagingCookie = null };
            while (true)
            {
                var pageResult = service.RetrieveMultiple(qe);
                if (pageResult.Entities != null && pageResult.Entities.Count > 0)
                    result.Entities.AddRange(pageResult.Entities);
                if (pageResult.MoreRecords)
                {
                    page++;
                    qe.PageInfo.PageNumber = page;
                    qe.PageInfo.PagingCookie = pageResult.PagingCookie;
                }
                else break;
            }
            return result;
        }

        private string ConvertAttributeValueToString(IOrganizationService service, object raw, AttributeMetadata meta, int depthLeft)
        {
            if (raw == null) return "";
            try
            {
                if (raw is EntityReference er)
                {
                    return $"{er.Name ?? ""} ({er.Id})";
                }
                if (raw is OptionSetValue osv)
                {
                    if (meta is EnumAttributeMetadata enumMeta && enumMeta.OptionSet?.Options != null)
                    {
                        var opt = enumMeta.OptionSet.Options.FirstOrDefault(o => o.Value == osv.Value);
                        if (opt?.Label?.UserLocalizedLabel != null) return opt.Label.UserLocalizedLabel.Label;
                    }
                    return osv.Value.ToString();
                }
                if (raw is OptionSetValueCollection osvc)
                {
                    return string.Join(";", osvc.Select(x => x.Value.ToString()));
                }
                if (raw is Money m) return m.Value.ToString("F2");
                if (raw is DateTime dt) return dt.ToString("o");
                if (raw is bool b) return b ? "true" : "false";
                if (raw is AliasedValue av) return ConvertAttributeValueToString(service, av.Value, meta, depthLeft);
                if (raw is string s) return s;
                if (raw is int || raw is long || raw is decimal || raw is double) return raw.ToString();
                return raw.ToString();
            }
            catch
            {
                return raw.ToString();
            }
        }

        private string CsvEscape(string input)
        {
            if (input == null) return "\"\"";
            var s = input.Replace("\"", "\"\"");
            return $"\"{s}\"";
        }

        #endregion

        #region Template result helpers & small utilities

        private void UpdateTemplateResult(IOrganizationService service, Entity template, string message)
        {
            try
            {
                var upd = new Entity(template.LogicalName, template.Id);
                if (!string.IsNullOrEmpty(Template_ResultField))
                    upd[Template_ResultField] = message;
                service.Update(upd);
            }
            catch { }
        }

        private string GetString(Entity e, string fld) => e.Contains(fld) ? e.GetAttributeValue<string>(fld) : null;
        private Guid GetGuid(Entity e, string fld) => e.Contains(fld) ? e.GetAttributeValue<Guid>(fld) : Guid.Empty;
        private int GetInt(Entity e, string fld, int defaultVal)
        {
            if (!e.Contains(fld)) return defaultVal;
            var o = e[fld];
            if (o is int i) return i;
            if (o is OptionSetValue osv) return osv.Value;
            if (o is long l) return (int)l;
            return defaultVal;
        }
        private bool GetBool(Entity e, string fld, bool defaultVal)
        {
            if (!e.Contains(fld)) return defaultVal;
            var o = e[fld];
            if (o is bool b) return b;
            if (o is OptionSetValue osv) return osv.Value != 0;
            return defaultVal;
        }

        #endregion
    }
}
äº”ã€å¦‚ä½•æ‰“åŒ… & æ³¨å†Œï¼ˆæ­¥éª¤ï¼‰

åœ¨ Visual Studio æ–°å»º Class Libraryï¼ˆ.NET Framework ä¸ä½  Dataverse SDK ç›¸å…¼å®¹ï¼Œä¾‹å¦‚ .NET Framework 4.7.2ï¼‰ã€‚

ç”¨ NuGet å®‰è£… Microsoft.CrmSdk.CoreAssembliesã€‚

æŠŠä¸Šé¢ RecursiveCsvExportPlugin.cs åŠ å…¥é¡¹ç›®ï¼Œç¼–è¯‘ç”Ÿæˆ DLLã€‚

ä½¿ç”¨ Plugin Registration Tool ä¸Šä¼ ç¨‹åºé›†ï¼ˆIsolation Mode: Sandbox æ¨èï¼‰ã€‚

æ³¨å†Œ Stepï¼ˆå»ºè®®ï¼‰ï¼š

Message: Createï¼ˆä¹Ÿå¯æ³¨å†Œ Updateï¼ŒFiltering Attributes å¡« new_statusï¼‰

Primary Entity: new_exporttemplateï¼ˆtemplate è¡¨ï¼‰

Stage: PostOperation

Execution Mode: Asynchronousï¼ˆæ¨èï¼‰

User: System æˆ–æœ‰è¶³å¤Ÿæƒé™çš„ç”¨æˆ·

åˆ›å»º new_exporttemplate è¡¨ä¸å­—æ®µï¼ˆè§ä¸Šæ–‡ï¼‰å¹¶ç¡®ä¿æ’ä»¶å¸¸é‡åŒ¹é…å­—æ®µåã€‚

åœ¨ç›®æ ‡å®ä½“ï¼ˆä¾‹å¦‚ new_caseï¼‰è¡¨å•ä¸Šæ·»åŠ  Ribbon æŒ‰é’®ï¼Œè°ƒç”¨ createExportRequest.jsã€‚

æµ‹è¯•æµç¨‹ï¼šåœ¨ Case è¡¨å•ç‚¹å‡»å¯¼å‡º â†’ åœ¨ new_exporttemplate çœ‹åˆ°è®°å½• â†’ å¼‚æ­¥æ’ä»¶æ‰§è¡Œ â†’ åœ¨ä¸»è®°å½• Notes/é™„ä»¶çœ‹åˆ° CSVã€‚



ğŸ§© ä¸€ã€ä¸»è¡¨åœ¨å¯¼å‡ºä¸­çš„åœ°ä½

ä¸»è¡¨ï¼ˆMain Tableï¼‰æ˜¯æ•´ä¸ªå¯¼å‡ºè¿‡ç¨‹çš„èµ·ç‚¹ã€‚
ä½ åœ¨ PowerApps æ¨¡å‹é©±åŠ¨åº”ç”¨ä¸­ç‚¹å‡»ã€ŒExport CSVã€æŒ‰é’®æ—¶ï¼Œä¼ å…¥çš„ GUIDï¼ˆé€šå¸¸æ˜¯ä¸»è¡¨è®°å½•çš„ä¸»é”®ï¼Œæ¯”å¦‚ CaseIdï¼‰å°±æ˜¯å¯¼å‡ºçš„æ ¹èŠ‚ç‚¹ã€‚

ä¾‹å¦‚ï¼š

ä½ ç‚¹çš„æ˜¯ Case è®°å½•ï¼ˆnew_caseï¼‰

æ’ä»¶åœ¨åå°æ ¹æ®è¿™ä¸ª CaseId å»æŸ¥ä¸»è¡¨çš„æ‰€æœ‰å­—æ®µ

ç„¶åé€’å½’å¤„ç†ï¼šå®ƒçš„å­è¡¨ã€Lookup å­—æ®µã€Lookup çš„ Lookupâ€¦

æ‰€ä»¥ ä¸»è¡¨æ°¸è¿œæ˜¯ CSV çš„ç¬¬ä¸€ä¸ª sectionã€‚

ğŸ§¾ äºŒã€CSV æ–‡ä»¶æ€»ä½“ç»“æ„ï¼ˆä¸»è¡¨ + å­è¡¨ + Lookupï¼‰

ä»¥ â€œCaseâ€ ä¸ºä¾‹ï¼Œæœ€ç»ˆå¯¼å‡ºçš„ CSV ç»“æ„å¦‚ä¸‹ ğŸ‘‡ï¼š

=== Main Table: new_case ===
CaseId,Title,Status,Customer,Customer_Name
c001,"ç½‘ç»œæ•…éšœ","å¤„ç†ä¸­","accountid_123","Contoso Ltd."

=== Sub Table: new_casesubtask (å­è¡¨ of new_case) ===
SubTaskId,Name,DueDate,Owner,Owner_Name
sub001,"ç°åœºæ£€æŸ¥","2025-10-20","userid_1","å¼ ä¸‰"
sub002,"æŠ¥å‘Šç¼–å†™","2025-10-21","userid_2","æå››"

=== Sub Table: new_casehistory (å­è¡¨ of new_case) ===
HistoryId,Action,CreatedOn,CreatedBy,CreatedBy_Name
his001,"åˆ›å»º","2025-10-19","userid_1","å¼ ä¸‰"
his002,"çŠ¶æ€æ›´æ–°","2025-10-20","userid_2","æå››"

=== Related Table: account (from Lookup: Customer) ===
AccountId,Name,ParentAccount,ParentAccount_Name
accountid_123,"Contoso Ltd.","accountid_999","Global Holding Inc."

=== Related Table: account (from Lookup: ParentAccount) ===
AccountId,Name,ParentAccount
accountid_999,"Global Holding Inc.",

ğŸ” ä¸‰ã€ä¸»è¡¨çš„ CSV section å†…å®¹

ä¸»è¡¨åœ¨ CSV çš„ç¬¬ä¸€å— section ä¸­å±•ç¤ºï¼š

æ ‡é¢˜è¡Œï¼š=== Main Table: {è¡¨å} ===

å­—æ®µè¡Œï¼šä¸»è¡¨æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ lookupã€textã€numberã€datetimeã€booleanï¼‰

æ•°æ®è¡Œï¼šå®é™…æ•°æ®

âš™ï¸ æ³¨æ„ï¼šlookup å­—æ®µä¼šæ˜¾ç¤ºä¸¤ä¸ªå€¼
ä¸€ä¸ªæ˜¯ lookup çš„ idï¼ˆä¾‹å¦‚ Customer = accountid_123ï¼‰ï¼Œ
å¦ä¸€ä¸ªæ˜¯ lookup çš„ nameï¼ˆä¾‹å¦‚ Customer_Name = Contoso Ltd.ï¼‰

ğŸ§  å››ã€ä¸»è¡¨å’Œå­è¡¨/lookup çš„é€’å½’å…³ç³»å›¾
Main Table: new_case
â”‚
â”œâ”€â”€ Sub Table: new_casesubtask
â”‚     â””â”€â”€ Lookup: Owner (SystemUser)
â”‚
â”œâ”€â”€ Sub Table: new_casehistory
â”‚     â””â”€â”€ Lookup: CreatedBy (SystemUser)
â”‚
â””â”€â”€ Lookup: Customer (Account)
      â””â”€â”€ Lookup: ParentAccount (Account)